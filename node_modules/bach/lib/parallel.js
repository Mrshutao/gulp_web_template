'use strict';

var initial = require('array-initial');
var last = require('array-last');
var asyncDone = require('async-done');
var nowAndLater = require('now-and-later');

var helpers = require('./helpers');

//迭代器
function iterator(fn, key, cb) {
  return asyncDone(fn, cb);
}

function buildParallel() {
  //取出任务数组
  var args = helpers.verifyArguments(arguments);
  //取出扩展
  var extensions = helpers.getExtensions(last(args));

  if (extensions) {
    args = initial(args);
  }

  function parallel(done) {
    //并发执行
    nowAndLater.map(args, iterator, extensions, done);
  }

  return parallel;
}

module.exports = buildParallel;
