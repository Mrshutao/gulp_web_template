'use strict';

var bach = require('bach');

var metadata = require('./helpers/metadata');
var buildTree = require('./helpers/buildTree');
var normalizeArgs = require('./helpers/normalizeArgs');
var createExtensions = require('./helpers/createExtensions');

function parallel() {
  var create = this._settle ? bach.settleParallel : bach.parallel;

  // 取出注册表中的task并返回数组
  var args = normalizeArgs(this._registry, arguments);
  //安装扩展，捕获last-run、任务执行钩子
  var extensions = createExtensions(this);
  //绑定扩展到每个task并执行
  var fn = create(args, extensions);
  var name = '<parallel>';
  //往weak-map中记录此次任务
  metadata.set(fn, {
    name: name,
    branch: true,//标识是组合任务
    tree: {
      label: name,
      type: 'function',
      branch: true,
      nodes: buildTree(args),//子任务
    },
  });
  return fn;
}

module.exports = parallel;
